<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Åå„Çì„Å∞„ÇåÔºÅ„É¢„É≥„Çπ„Çø„ÉºË®é‰ºêÈöä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation;
        }
        .btn-3d {
            transition: all 0.1s ease-out;
            box-shadow: 0 6px 0 #a3a3a3;
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #a3a3a3;
        }
        .btn-3d:disabled {
            transform: translateY(2px);
            box-shadow: 0 4px 0 #9ca3af;
            background-color: #d1d5db;
            cursor: not-allowed;
        }
        @keyframes spawn {
            0% { transform: scale(0.5) translateY(50px); opacity: 0; }
            70% { transform: scale(1.1) translateY(0); opacity: 1; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .animate-spawn { animation: spawn 0.5s ease-out forwards; }
        @keyframes defeat {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.2) rotate(15deg); opacity: 0.5; }
            100% { transform: scale(0.1) rotate(-360deg); opacity: 0; }
        }
        .animate-defeat { animation: defeat 0.6s ease-in forwards; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        @keyframes celebrate-text {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .animate-celebrate { animation: celebrate-text 1s ease-in-out infinite; }
        @keyframes gameover-text {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(-2deg); }
            75% { transform: scale(1.05) rotate(2deg); }
        }
        .animate-gameover { animation: gameover-text 0.5s ease-in-out; }
        .touch-none {
            touch-action: none;
        }
    </style>
</head>
<body class="bg-yellow-50 text-gray-800 flex items-center justify-center min-h-screen">
    <div id="app-container" class="w-full max-w-5xl mx-auto p-4 text-center">

        <!-- „Éá„ÉÉ„Ç≠ÈÅ∏ÊäûÁîªÈù¢ -->
        <div id="deck-selection-screen" class="space-y-6">
            <h1 class="text-5xl font-extrabold text-amber-600">„Åå„Çì„Å∞„ÇåÔºÅ<br>„É¢„É≥„Çπ„Çø„ÉºË®é‰ºêÈöä</h1>
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6">„Å©„ÅÆ„Éá„ÉÉ„Ç≠„Åß„Åü„Åü„Åã„ÅÜÔºü</h2>
                <div id="deck-list" class="space-y-4 mb-6 max-h-80 overflow-y-auto"></div>
                <button id="new-deck-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 w-full rounded-lg text-2xl btn-3d">+ „ÅÇ„Åü„Çâ„Åó„ÅÑ„Éá„ÉÉ„Ç≠„Çí„Å§„Åè„Çã</button>
            </div>
        </div>

        <!-- „Éá„ÉÉ„Ç≠Á∑®ÈõÜÁîªÈù¢ -->
        <div id="deck-editor-screen" class="hidden space-y-4">
            <h2 class="text-4xl font-bold text-amber-600">„Éá„ÉÉ„Ç≠„ÅÆ„Å∏„Çì„Åó„ÇÖ„ÅÜ</h2>
            <div class="bg-white p-8 rounded-2xl shadow-lg text-left">
                <div class="mb-6">
                    <label for="deck-name" class="font-bold text-xl">„Éá„ÉÉ„Ç≠„ÅÆ„Å™„Åæ„Åà</label>
                    <input type="text" id="deck-name" class="w-full text-xl p-3 border rounded mt-2" placeholder="‰æãÔºö„Åã„Çì„Åò„ÉÜ„Çπ„Éà">
                </div>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-xl">„ÇÇ„Çì„Å†„ÅÑ„É™„Çπ„Éà</h3>
                </div>
                <div id="questions-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto p-4 bg-gray-50 rounded min-h-[100px]"></div>
                <div class="border-t pt-6">
                    <h3 class="font-bold text-xl mb-4">„ÅÇ„Åü„Çâ„Åó„ÅÑ„ÇÇ„Çì„Å†„ÅÑ</h3>
                    <div class="mb-4">
                         <label for="new-question" class="text-lg">„ÇÇ„Çì„Å†„ÅÑ</label>
                         <textarea id="new-question" rows="2" class="w-full p-3 border rounded mt-1 text-lg" placeholder="‰æãÔºöÊó•Êú¨„ÅÆÈ¶ñÈÉΩ„ÅØÔºü"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="new-answer" class="text-lg">„Åì„Åü„Åà</label>
                        <input type="text" id="new-answer" class="w-full p-3 border rounded mt-1 text-lg" placeholder="‰æãÔºöÊù±‰∫¨">
                    </div>
                    <button id="add-question-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg btn-3d text-xl">„ÇÇ„Çì„Å†„ÅÑ„Çí„Å§„ÅÑ„Åã</button>
                </div>
            </div>
             <div class="grid grid-cols-2 gap-6 mt-6">
                 <button id="save-deck-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-4 rounded-lg text-2xl btn-3d">„Åì„ÅÆ„Éá„ÉÉ„Ç≠„Çí„Åª„Åû„Çì</button>
                 <button id="back-to-selection-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 rounded-lg text-2xl btn-3d">„ÇÇ„Å©„Çã</button>
            </div>
        </div>

        <!-- ÂïèÈ°åÊï∞ÈÅ∏ÊäûÁîªÈù¢ -->
        <div id="setup-screen" class="hidden space-y-6">
            <h1 id="setup-title" class="text-4xl font-extrabold text-amber-600"></h1>
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6">„Å™„Çì„Å≥„Åç „Å®„ÅÜ„Å∞„Å§„Åô„ÇãÔºü</h2>
                <div id="question-count-buttons" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></div>
                 <button id="back-to-decks-btn" class="mt-6 w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 rounded-lg text-2xl btn-3d">„Éá„ÉÉ„Ç≠„Çí„Åà„Çâ„Å≥„Å™„Åä„Åô</button>
            </div>
        </div>

        <!-- „É°„Ç§„É≥ÁîªÈù¢ -->
        <div id="main-screen" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-lg relative">
                 <div id="game-buttons" class="absolute top-6 right-6 flex flex-col space-y-4">
                    <button id="correct-btn" class="bg-green-500 hover:bg-green-600 text-white font-extrabold py-4 px-6 rounded-xl text-2xl btn-3d">„Åõ„ÅÑ„Åã„ÅÑÔºÅ</button>
                    <button id="retry-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-extrabold py-4 px-6 rounded-xl text-2xl btn-3d">Ëß£„ÅçÁõ¥„Åó</button>
                </div>
                <div class="flex justify-between items-center mb-4 pr-48">
                    <h2 id="monster-title" class="text-3xl font-bold text-amber-600"></h2>
                    <p id="counter" class="text-2xl font-bold bg-gray-200 px-6 py-2 rounded-full"></p>
                </div>

                <div class="w-full bg-gray-200 rounded-full h-5 mb-4">
                    <div id="timer-bar" class="bg-gradient-to-r from-yellow-400 to-red-500 h-5 rounded-full" style="width: 100%; transition: width 1s linear;"></div>
                </div>

                <div id="lives-area" class="flex justify-center gap-3 text-4xl mb-4"></div>
                <div class="bg-gray-100 p-6 rounded-lg my-6 min-h-[150px] flex flex-col justify-center">
                    <div id="question-display" class="text-4xl font-bold mb-2"></div>
                </div>

                <div id="monster-area" class="h-48 flex items-center justify-center"></div>

                <div class="my-6">
                    <label class="font-bold text-left block mb-3 text-gray-600 text-xl">„Åì„Åü„Åà„Çí„Åã„ÅÑ„Å¶„Åø„Çà„ÅÜÔºÅ</label>
                    <canvas id="handwriting-canvas" class="bg-white border-2 border-gray-300 rounded-lg w-full h-64 cursor-crosshair touch-none"></canvas>
                    <button id="clear-canvas-btn" class="mt-4 w-1/3 mx-auto bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg btn-3d text-xl">„Åë„Åô</button>
                </div>
            </div>
        </div>

        <!-- „ÇØ„É™„Ç¢ÁîªÈù¢ -->
        <div id="clear-screen" class="hidden">
            <canvas id="confetti-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
            <div class="bg-white p-12 rounded-2xl shadow-2xl space-y-6">
                <h1 class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 animate-celebrate">„Åú„Çì„Å∂ „ÇÑ„Å£„Å§„Åë„ÅüÔºÅ<br>„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</h1>
                <p class="text-9xl">üèÜ‚ú®üéâ</p>
                <div id="clear-results-area" class="text-left max-h-60 overflow-y-auto bg-gray-50 p-6 rounded-lg border"></div>
                <button class="restart-btn bg-cyan-400 hover:bg-cyan-500 text-white font-bold py-5 px-10 rounded-lg text-3xl btn-3d">„ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑ</button>
            </div>
        </div>

        <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢ -->
        <div id="gameover-screen" class="hidden">
            <div class="bg-gray-800 p-12 rounded-2xl shadow-2xl space-y-6 text-white">
                <h1 class="text-6xl font-extrabold text-red-500 animate-gameover">„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</h1>
                <p class="text-9xl">üò≠</p>
                <p class="text-2xl">„Åñ„Çì„Å≠„Çì‚Ä¶<br>„Åæ„Åü„Å°„Çá„ÅÜ„Åõ„Çì„Åó„Å¶„Å≠ÔºÅ</p>
                <div id="gameover-results-area" class="text-left max-h-60 overflow-y-auto bg-gray-700 p-6 rounded-lg border border-gray-600"></div>
                <button class="restart-btn bg-cyan-400 hover:bg-cyan-500 font-bold py-5 px-10 rounded-lg text-3xl btn-3d">„ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑ</button>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOMË¶ÅÁ¥† ---
        const screens = {
            deckSelection: document.getElementById('deck-selection-screen'),
            deckEditor: document.getElementById('deck-editor-screen'),
            setup: document.getElementById('setup-screen'),
            main: document.getElementById('main-screen'),
            clear: document.getElementById('clear-screen'),
            gameover: document.getElementById('gameover-screen'),
        };
        const deckList = document.getElementById('deck-list');
        const newDeckBtn = document.getElementById('new-deck-btn');
        const deckEditorIndex = document.getElementById('deck-editor-index');
        const deckNameInput = document.getElementById('deck-name');
        const questionsList = document.getElementById('questions-list');
        const newQuestionInput = document.getElementById('new-question');
        const newAnswerInput = document.getElementById('new-answer');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const saveDeckBtn = document.getElementById('save-deck-btn');
        const backToSelectionBtn = document.getElementById('back-to-selection-btn');
        const setupTitle = document.getElementById('setup-title');
        const questionCountButtons = document.getElementById('question-count-buttons');
        const backToDecksBtn = document.getElementById('back-to-decks-btn');
        const monsterTitle = document.getElementById('monster-title');
        const counter = document.getElementById('counter');
        const livesArea = document.getElementById('lives-area');
        const questionDisplay = document.getElementById('question-display');
        const monsterArea = document.getElementById('monster-area');
        const correctBtn = document.getElementById('correct-btn');
        const retryBtn = document.getElementById('retry-btn');
        const handwritingCanvas = document.getElementById('handwriting-canvas');
        const clearCanvasBtn = document.getElementById('clear-canvas-btn');
        const timerBar = document.getElementById('timer-bar');

        // --- „Ç≤„Éº„É†Áä∂ÊÖã ---
        let decks = [];
        let currentDeckIndex = -1;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let totalMonsters = 0;
        let defeatedMonsters = 0;
        let mistakes = 0;
        const MAX_MISTAKES = 3;
        let buttonsDisabled = false;
        let questionTimer = null;
        const TIME_LIMIT = 15;

        // --- „É¢„É≥„Çπ„Çø„Éº ---
        const MONSTERS = [
            { name: '„Çµ„Ç§„Éê„Ç§„Éû„É≥', image: 'https://img.atwiki.jp/dragonuteningyougeki/attach/58/58/%E3%82%B5%E3%82%A4%E3%83%90%E3%82%A4%E3%83%9E%E3%83%B3.png', emoji: 'üå±' },
            { name: '„É©„Éá„Ç£„ÉÉ„ÉÑ', image: 'https://dragon-ball-official.com/dragonball/jp/news/2021/09/chara21_1.jpg?_=1755538260', emoji: 'üë®‚Äç' },
            { name: '„Éä„ÉÉ„Éë', image: 'https://dba.bn-ent.net/character/images/nappa/portrait.png', emoji: 'üí™' },
            { name: '„Éô„Ç∏„Éº„Çø', image: 'https://dba.bn-ent.net/character/images/vegeta/portrait.png', emoji: 'üëë' },
            { name: '„ÇÆ„Éã„É•„ÉºÁâπÊà¶Èöä', image: 'https://lineup.toei-anim.co.jp/upload/save_image/episode/6168/story_img_1.jpg', emoji: 'üï∫' },
            { name: '„Éï„É™„Éº„Ç∂Á¨¨‰∏ÄÂΩ¢ÊÖã', image: 'https://dragon-ball-official.com/dragonball/jp/news/2021/10/chara23_1.jpg?_=1756504020', emoji: 'üëπ' },
            // { name: '„Éï„É™„Éº„Ç∂ÊúÄÁµÇÂΩ¢ÊÖã', image: 'https://i.imgur.com/placeholder7.png', emoji: 'ÔøΩ' },
            // { name: '„Çª„É´Á¨¨‰∏ÄÂΩ¢ÊÖã', image: 'https://avatars.dicebear.com/api/bottts/cell1.svg', emoji: 'ü¶Ç' },
            // { name: '„Çª„É´ÂÆåÂÖ®‰Ωì', image: 'https://i.imgur.com/placeholder9.png', emoji: 'ÔøΩ' },
            // { name: 'È≠î‰∫∫„Éñ„Ç¶', image: 'https://avatars.dicebear.com/api/bottts/majin-buu.svg', emoji: 'üç≠' },
            // { name: '„Éñ„É≠„É™„Éº', image: 'https://i.imgur.com/placeholder11.png', emoji: 'ÔøΩ' },
            // { name: '„Ç∏„É£„Éç„É≥„Éê', image: 'https://i.imgur.com/placeholder12.png', emoji: 'ÔøΩ' }
        ];
        const BOSS_MONSTER = { name: 'Á•ûÈæçÔºà„Ç∑„Çß„É≥„É≠„É≥Ôºâ', image: 'https://cdn.ibispaint.com/movie/277/351/277351048/image277351048.png', emoji: 'üêâ' };


        // --- Canvas State ---
        let canvasCtx;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // --- ÁîªÈù¢Âàá„ÇäÊõø„Åà ---
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screens[screenId].classList.remove('hidden');
        }

        // --- „Éá„ÉÉ„Ç≠ÁÆ°ÁêÜ ---
        function loadDecks() {
            decks = JSON.parse(localStorage.getItem('monsterDecks')) || [];
            renderDeckSelectionScreen();
        }

        function saveDecks() {
            localStorage.setItem('monsterDecks', JSON.stringify(decks));
            renderDeckSelectionScreen();
        }

        function renderDeckSelectionScreen() {
            deckList.innerHTML = '';
            if (decks.length === 0) {
                deckList.innerHTML = `<p class="text-gray-500 text-xl">„Éá„ÉÉ„Ç≠„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br>„ÅÇ„Åü„Çâ„Åó„ÅÑ„Éá„ÉÉ„Ç≠„Çí„Å§„Åè„Çç„ÅÜÔºÅ</p>`;
            }
            decks.forEach((deck, index) => {
                const deckEl = document.createElement('div');
                deckEl.className = 'flex items-center gap-4';
                deckEl.innerHTML = `
                    <button data-index="${index}" class="start-game-btn flex-grow bg-cyan-400 hover:bg-cyan-500 text-white font-bold py-4 px-6 rounded-lg text-2xl btn-3d">${deck.name} (${deck.questions.length}„ÇÇ„Çì)</button>
                    <button data-index="${index}" class="edit-deck-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold p-4 rounded-lg btn-3d text-2xl">‚úèÔ∏è</button>
                    <button data-index="${index}" class="delete-deck-btn bg-red-500 hover:bg-red-600 text-white font-bold p-4 rounded-lg btn-3d text-2xl">üóëÔ∏è</button>
                `;
                deckList.appendChild(deckEl);
            });
        }

        // --- „Éá„ÉÉ„Ç≠Á∑®ÈõÜÁîªÈù¢„ÅÆÂá¶ÁêÜ ---
        let tempQuestions = [];
        function openDeckEditor(index = -1) {
            currentDeckIndex = index;
            if (index === -1) {
                deckNameInput.value = '';
                tempQuestions = [];
            } else {
                deckNameInput.value = decks[index].name;
                tempQuestions = JSON.parse(JSON.stringify(decks[index].questions));
            }
            renderQuestionsList();
            showScreen('deckEditor');
        }

        function renderQuestionsList() {
            questionsList.innerHTML = '';
            if(tempQuestions.length === 0) {
                questionsList.innerHTML = `<p class="text-gray-400 text-center p-4 text-lg">„Åæ„Å†ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>`;
            }
            tempQuestions.forEach((q, index) => {
                const qEl = document.createElement('div');
                qEl.className = 'bg-white p-3 border rounded flex justify-between items-center text-lg';
                qEl.innerHTML = `
                    <span class="truncate pr-2"><b>Q:</b> ${q.q} / <b>A:</b> ${q.a}</span>
                    <button data-index="${index}" class="delete-question-btn bg-red-500 text-white rounded px-3 py-1 text-base">„Åï„Åè„Åò„Çá</button>
                `;
                questionsList.appendChild(qEl);
            });
        }

        // --- „Ç≤„Éº„É†ÈñãÂßãÊ∫ñÂÇô ---
        function showSetupScreen(deckIndex) {
            currentDeckIndex = deckIndex;
            const deck = decks[deckIndex];
            setupTitle.textContent = `„Äé${deck.name}„Äè`;
            questionCountButtons.innerHTML = '';
            const counts = [5, 10, 15, 20];
            counts.forEach(count => {
                 questionCountButtons.innerHTML += `<button data-questions="${count}" class="question-btn bg-cyan-400 hover:bg-cyan-500 text-white font-bold py-5 px-4 rounded-lg text-2xl btn-3d">${count}„Å≤„Åç</button>`;
            });
             if (deck.questions.length > 0 && deck.questions.length < 5) {
                 questionCountButtons.innerHTML += `<button data-questions="${deck.questions.length}" class="question-btn bg-cyan-400 hover:bg-cyan-500 text-white font-bold py-5 px-4 rounded-lg text-2xl btn-3d">${deck.questions.length}„Å≤„Åç</button>`;
            }
            if (deck.questions.length === 0) {
                 questionCountButtons.innerHTML = `<p class="text-gray-500 col-span-2 text-xl">ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br>„Éá„ÉÉ„Ç≠„ÇíÁ∑®ÈõÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>`
            }
            showScreen('setup');
        }

        // --- „Ç≤„Éº„É†Êú¨‰Ωì ---
        function startGame(numQuestions) {
            totalMonsters = numQuestions;
            defeatedMonsters = 0;
            mistakes = 0;
            buttonsDisabled = false;

            let deckQuestions = [...decks[currentDeckIndex].questions];
            currentQuestions = deckQuestions.sort(() => 0.5 - Math.random());
            currentQuestions.forEach(q => q.result = null);
            currentQuestionIndex = 0;

            updateLives();
            showScreen('main');
            initializeCanvas();
            spawnMonster();
            displayQuestion();
            updateCounter();
        }

        function nextTurn() {
            buttonsDisabled = false;
            updateCounter();
            spawnMonster();
            displayQuestion();
        }

        function displayQuestion() {
            clearCanvas();

            if (currentQuestionIndex >= currentQuestions.length) {
                if (mistakes < MAX_MISTAKES) {
                    showClearScreen();
                } else {
                    showGameOverScreen();
                }
                return;
            }

            const qa = currentQuestions[currentQuestionIndex];
            questionDisplay.innerHTML = `<b>„ÇÇ„Çì„Å†„ÅÑÔºö</b> ${qa.q}`;
            buttonsDisabled = false;
            startTimer();
        }

        function spawnMonster() {
            monsterArea.innerHTML = '';
            let monster;
            let monsterSize = 'w-60 h-60';

            if (defeatedMonsters === totalMonsters - 1) {
                monster = BOSS_MONSTER;
                monsterTitle.textContent = `„Å§„ÅÑ„Å´${monster.name}„Åå„ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`;
                monsterSize = 'w-60 h-60';
            } else {
                monster = MONSTERS[Math.floor(Math.random() * MONSTERS.length)];
                monsterTitle.textContent = `${monster.name}„Åå„ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`;
            }

            const monsterEl = document.createElement('div');
            monsterEl.className = `${monsterSize} animate-spawn flex items-center justify-center`;

            // ÁîªÂÉè„ÇíË©¶„Åó„Å¶„ÄÅÂ§±Êïó„Åó„Åü„ÇâÁµµÊñáÂ≠ó„ÇíË°®Á§∫
            const img = document.createElement('img');
            img.src = monster.image;
            img.className = 'w-full h-full object-contain rounded-lg';
            img.alt = monster.name;

            const fallbackEl = document.createElement('div');
            fallbackEl.textContent = monster.emoji;
            fallbackEl.className = 'text-8xl';
            fallbackEl.style.display = 'none';

            img.onerror = () => {
                img.style.display = 'none';
                fallbackEl.style.display = 'block';
            };

            monsterEl.appendChild(img);
            monsterEl.appendChild(fallbackEl);
            monsterArea.appendChild(monsterEl);
        }

        function updateCounter() {
            counter.textContent = `„ÅÆ„Åì„Çä ${totalMonsters - defeatedMonsters} „Å≤„Åç`;
        }

        function updateLives() {
            livesArea.innerHTML = '‚ù§Ô∏è'.repeat(MAX_MISTAKES - mistakes) + 'üñ§'.repeat(mistakes);
        }

        function handleCorrect() {
            stopTimer();
            if (buttonsDisabled || currentQuestionIndex >= currentQuestions.length) return;
            buttonsDisabled = true;

            currentQuestions[currentQuestionIndex].result = 'correct';
            const monsterEl = monsterArea.querySelector('div');

            monsterEl?.classList.add('animate-defeat');

            monsterEl?.addEventListener('animationend', () => {
                defeatedMonsters++;
                currentQuestionIndex++;
                if (defeatedMonsters >= totalMonsters) {
                    showClearScreen();
                } else {
                    nextTurn();
                }
            }, { once: true });
        }

        function handleRetry() {
            if (buttonsDisabled) return;

            const monsterEl = monsterArea.querySelector('div');
            monsterEl?.classList.add('animate-shake');
            monsterEl?.addEventListener('animationend', () => {
                monsterEl.classList.remove('animate-shake');
            }, { once: true });

            clearCanvas();
        }

        function handleTimeUp() {
            stopTimer();
            if (buttonsDisabled || currentQuestionIndex >= currentQuestions.length) return;
            buttonsDisabled = true;

            currentQuestions[currentQuestionIndex].result = 'incorrect';
            mistakes++;
            updateLives();

            if (mistakes >= MAX_MISTAKES) {
                showGameOverScreen();
                return;
            }

            const monsterEl = monsterArea.querySelector('div');
            monsterEl?.classList.add('animate-shake');

            monsterEl?.addEventListener('animationend', () => {
                monsterEl.classList.remove('animate-shake');
                currentQuestionIndex++;

                if (currentQuestionIndex >= currentQuestions.length) {
                    showGameOverScreen();
                } else {
                    displayQuestion();
                }
            }, { once: true });
        }

        // --- „Çø„Ç§„Éû„ÉºÊ©üËÉΩ ---
        function startTimer() {
            stopTimer();
            let timeLeft = TIME_LIMIT;
            timerBar.style.transition = 'width 1s linear';

            const updateTimerDisplay = () => {
                const percentage = (timeLeft / TIME_LIMIT) * 100;
                timerBar.style.width = `${percentage}%`;
            };

            updateTimerDisplay();

            questionTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft < 0) {
                    handleTimeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            if (questionTimer) {
                clearInterval(questionTimer);
                questionTimer = null;
            }
            timerBar.style.transition = 'none';
        }

        // --- CanvasÊèèÁîª ---
        function initializeCanvas() {
            if(!canvasCtx) canvasCtx = handwritingCanvas.getContext('2d');
            const { width, height } = handwritingCanvas.getBoundingClientRect();
            handwritingCanvas.width = width;
            handwritingCanvas.height = height;
            canvasCtx.strokeStyle = '#374151';
            canvasCtx.lineWidth = 5;
            canvasCtx.lineJoin = 'round';
            canvasCtx.lineCap = 'round';
            clearCanvas();
        }

        function clearCanvas() {
            if(canvasCtx) canvasCtx.clearRect(0, 0, handwritingCanvas.width, handwritingCanvas.height);
        }

        function getCoords(e) {
            const rect = handwritingCanvas.getBoundingClientRect();
            const touch = e.touches && e.touches[0];
            return [
                (touch ? touch.clientX : e.clientX) - rect.left,
                (touch ? touch.clientY : e.clientY) - rect.top
            ];
        }

        function startDrawing(e) { e.preventDefault(); isDrawing = true; [lastX, lastY] = getCoords(e); }
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const [currentX, currentY] = getCoords(e);
            canvasCtx.beginPath();
            canvasCtx.moveTo(lastX, lastY);
            canvasCtx.lineTo(currentX, currentY);
            canvasCtx.stroke();
            [lastX, lastY] = [currentX, currentY];
        }
        function stopDrawing() { isDrawing = false; }

        function renderResults(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '<h3 class="text-2xl font-bold mb-4 text-center">„ÇÇ„Çì„Å†„ÅÑ„Å®„Åì„Åü„Åà</h3>';
            const list = document.createElement('ul');
            list.className = 'space-y-4';
            const answeredQuestions = currentQuestions.filter(q => q.result);
            answeredQuestions.forEach(qa => {
                const item = document.createElement('li');
                item.className = 'border-b border-gray-400 pb-3 text-lg';
                let resultHTML = '';
                if (qa.result === 'correct') {
                    resultHTML = `<span class="font-bold text-green-500 mr-2">[„Åõ„ÅÑ„Åã„ÅÑÔºÅ]</span>`;
                } else if (qa.result === 'incorrect') {
                    resultHTML = `<span class="font-bold text-red-500 mr-2">[„Åµ„Åõ„ÅÑ„Åã„ÅÑ‚Ä¶]</span>`;
                }
                item.innerHTML = `<div>${resultHTML}<b>Q:</b> ${qa.q}</div><div class="pl-6"><b class="${containerId.includes('clear') ? 'text-blue-600' : 'text-cyan-400'}">A:</b> ${qa.a}</div>`;
                list.appendChild(item);
            });
            if (answeredQuestions.length === 0) { list.innerHTML = `<p class="text-gray-500">„Åë„Å£„Åã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>`; }
            container.appendChild(list);
        }

        function showClearScreen() {
            stopTimer();
            showScreen('clear');
            renderResults('clear-results-area');
            startConfetti();
        }

        function showGameOverScreen() {
            stopTimer();
            showScreen('gameover');
            renderResults('gameover-results-area');
        }

        // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---
        deckList.addEventListener('click', e => {
            const target = e.target.closest('button');
            if (!target) return;
            const index = parseInt(target.dataset.index);
            if (target.classList.contains('start-game-btn')) {
                if(decks[index].questions.length > 0) showSetupScreen(index);
                else alert('„Åì„ÅÆ„Éá„ÉÉ„Ç≠„Å´„ÅØÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁ∑®ÈõÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } else if (target.classList.contains('edit-deck-btn')) {
                openDeckEditor(index);
            } else if (target.classList.contains('delete-deck-btn')) {
                if (confirm(`„Äå${decks[index].name}„Äç„ÇíÊú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                    decks.splice(index, 1);
                    saveDecks();
                }
            }
        });

        newDeckBtn.addEventListener('click', () => openDeckEditor(-1));
        addQuestionBtn.addEventListener('click', () => {
            const q = newQuestionInput.value.trim();
            const a = newAnswerInput.value.trim();
            if (q && a) {
                tempQuestions.push({ q, a });
                newQuestionInput.value = '';
                newAnswerInput.value = '';
                renderQuestionsList();
                newQuestionInput.focus();
            }
        });
        questionsList.addEventListener('click', e => {
            if (e.target.classList.contains('delete-question-btn')) {
                const index = parseInt(e.target.dataset.index);
                tempQuestions.splice(index, 1);
                renderQuestionsList();
            }
        });
        saveDeckBtn.addEventListener('click', () => {
            const name = deckNameInput.value.trim();
            if (!name) {
                alert('„Éá„ÉÉ„Ç≠„ÅÆ„Å™„Åæ„Åà„Çí„ÅÑ„Çå„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            const newDeck = { name, questions: tempQuestions };
            if (currentDeckIndex === -1) {
                decks.push(newDeck);
            } else {
                decks[currentDeckIndex] = newDeck;
            }
            saveDecks();
            showScreen('deckSelection');
        });
        backToSelectionBtn.addEventListener('click', () => showScreen('deckSelection'));
        questionCountButtons.addEventListener('click', e => {
            if (e.target.classList.contains('question-btn')) {
                startGame(parseInt(e.target.dataset.questions));
            }
        });
        backToDecksBtn.addEventListener('click', () => showScreen('deckSelection'));
        correctBtn.addEventListener('click', handleCorrect);
        retryBtn.addEventListener('click', handleRetry);

        document.querySelectorAll('.restart-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                showScreen('deckSelection');
                stopConfetti();
            });
        });

        // Canvas Event Listeners
        handwritingCanvas.addEventListener('mousedown', startDrawing);
        handwritingCanvas.addEventListener('mousemove', draw);
        handwritingCanvas.addEventListener('mouseup', stopDrawing);
        handwritingCanvas.addEventListener('mouseout', stopDrawing);
        handwritingCanvas.addEventListener('touchstart', startDrawing, { passive: false });
        handwritingCanvas.addEventListener('touchmove', draw, { passive: false });
        handwritingCanvas.addEventListener('touchend', stopDrawing);
        clearCanvasBtn.addEventListener('click', clearCanvas);
        window.addEventListener('resize', initializeCanvas);

        // --- ÂàùÊúüÂåñ ---
        loadDecks();
        showScreen('deckSelection');

        // --- Á¥ôÂêπÈõ™ (ÁúÅÁï•„ÄÅÂ§âÊõ¥„Å™„Åó) ---
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let confettiParticles = []; let animationFrameId;
        function startConfetti(){if(!canvas)return;canvas.width=canvas.offsetWidth;canvas.height=canvas.offsetHeight;confettiParticles=[];for(let i=0;i<100;i++){confettiParticles.push(createParticle())}renderConfetti()}
        function stopConfetti(){if(animationFrameId)cancelAnimationFrame(animationFrameId)}
        function createParticle(){const colors=['#f9a8d4','#f472b6','#86efac','#34d399','#67e8f9','#22d3ee','#fcd34d','#fbbf24'];return{x:Math.random()*canvas.width,y:Math.random()*canvas.height-canvas.height,size:Math.random()*8+5,color:colors[Math.floor(Math.random()*colors.length)],speed:Math.random()*3+2,angle:Math.random()*360,spin:Math.random()<.5?-1:1}}
        function renderConfetti(){if(!canvas)return;ctx.clearRect(0,0,canvas.width,canvas.height);confettiParticles.forEach((p,i)=>{p.y+=p.speed;p.angle+=p.spin*5;ctx.save();ctx.fillStyle=p.color;ctx.translate(p.x+p.size/2,p.y+p.size/2);ctx.rotate(p.angle*Math.PI/180);ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);ctx.restore();if(p.y>canvas.height){confettiParticles[i]=createParticle();confettiParticles[i].y=-10}});animationFrameId=requestAnimationFrame(renderConfetti)}
    });
    </script>
</body>
</html>

