<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>約数タイムアタック</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    <style>
        html, body {
            width: 100%;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        /* M PLUS Rounded 1c フォントを適用 */
        body {
            font-family: 'Inter', 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation; /* ダブルタップズームを無効化 */
        }

        /* ゲーム画面表示中のスクロールを無効化 */
        body.no-scroll {
            overflow: hidden;
            height: 100vh;
        }

        .btn-3d {
            transition: all 0.1s ease-out;
            box-shadow: 0 6px 0 #6b7280;
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #6b7280;
        }
        .question-count-btn {
            transition: all 0.2s ease;
        }
        .question-count-btn.selected {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 0 #3730a3; /* indigo-800 */
        }

        /* カードのフリップアニメーション */
        .card {
            transform-style: preserve-3d;
            transition: transform 0.5s, opacity 0.5s;
        }
        .card.is-correct {
            transform: rotateY(180deg) scale(0.8);
            opacity: 0;
        }
        .card.is-incorrect {
            animation: shake 0.5s;
        }

        /* カードが揺れるアニメーション */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); }
        }

        /* 画面のフェードイン・アウト */
        .screen {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* 結果画面のタイトルアニメーション */
        @keyframes celebrate-text {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .animate-celebrate { animation: celebrate-text 1s ease-in-out infinite; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen">

    <div id="game-container" class="w-full max-w-md mx-auto p-4 sm:p-6 text-center">

        <!-- スタート画面 -->
        <div id="start-screen" class="screen space-y-4 sm:space-y-6">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-600">約数タイムアタック</h1>
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="text-left max-w-md mx-auto space-y-2 text-gray-600 mb-6 text-sm sm:text-base">
                    <p>🚀 お題の数の約数をすべて見つけるゲームだよ。</p>
                    <p>⏱️ 全問正解するまでのタイムを競おう！</p>
                    <p>⚠️ まちがった数字を選ぶとペナルティタイムが3秒ついかされるよ。</p>
                </div>

                <div class="mt-6">
                    <p class="text-lg sm:text-xl font-bold mb-4">なん問チャレンジする？</p>
                    <div id="question-count-selector" class="flex justify-center gap-2 sm:gap-4">
                        <button class="question-count-btn btn-3d bg-gray-200 text-xl sm:text-2xl font-bold py-3 px-4 sm:px-6 rounded-lg selected" data-count="3">3問</button>
                        <button class="question-count-btn btn-3d bg-gray-200 text-xl sm:text-2xl font-bold py-3 px-4 sm:px-6 rounded-lg" data-count="5">5問</button>
                        <button class="question-count-btn btn-3d bg-gray-200 text-xl sm:text-2xl font-bold py-3 px-4 sm:px-6 rounded-lg" data-count="10">10問</button>
                    </div>
                </div>

                <button id="start-button" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 sm:py-4 rounded-lg text-2xl sm:text-3xl btn-3d">
                    スタート！
                </button>
                <p class="text-xs sm:text-sm text-gray-500 mt-4 sm:mt-6">効果音：OtoLogic</p>
            </div>
        </div>

        <!-- ゲーム画面 -->
        <div id="game-screen" class="screen hidden">
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-4">
                <div class="flex justify-between items-center text-lg">
                    <div class="text-left">
                        <span class="text-slate-500">ステージ</span>
                        <p class="font-bold text-2xl"><span id="stage-display">1</span> / <span id="max-stage-display">3</span></p>
                    </div>
                    <div class="text-right">
                         <span class="text-slate-500">タイム</span>
                        <p class="font-bold text-2xl"><span id="timer-display">0.00</span></p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl text-slate-600 mb-1">お題</h2>
                <p id="problem-number-display" class="text-5xl sm:text-6xl font-bold text-indigo-600 mb-6"></p>
                <!-- 数字カードのフィールド -->
                <div id="card-grid" class="grid grid-cols-4 gap-3">
                    <!-- JavaScriptでカードが生成される -->
                </div>
            </div>

            <div class="mt-6">
                 <button id="quit-button" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg text-lg btn-3d" style="box-shadow: 0 6px 0 #4b5563;">
                    ゲームをやめる
                </button>
            </div>
        </div>

        <!-- 結果画面 -->
        <div id="end-screen" class="screen hidden">
            <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none"></canvas>
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl space-y-4 sm:space-y-6">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 animate-celebrate">クリア！</h1>

                <div class="grid grid-cols-1 gap-2 sm:gap-4 text-center text-lg sm:text-xl">
                    <div class="bg-gray-100 p-3 sm:p-4 rounded-lg">
                        <p class="text-base sm:text-lg text-gray-500">かかった時間</p>
                        <p id="result-time" class="font-bold"></p>
                    </div>
                    <div class="bg-gray-100 p-3 sm:p-4 rounded-lg">
                        <p class="text-base sm:text-lg text-gray-500">ペナルティ</p>
                        <p id="result-penalty" class="font-bold text-red-500"></p>
                    </div>
                    <div class="bg-gray-100 p-3 sm:p-4 rounded-lg">
                        <p class="text-base sm:text-lg text-gray-500">最終スコア</p>
                        <p id="result-score" class="font-bold text-indigo-500"></p>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 mt-6">
                    <button id="retry-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 sm:py-4 rounded-lg text-lg sm:text-xl btn-3d" style="box-shadow: 0 6px 0 #166534;">
                        再チャレンジ
                    </button>
                    <button id="restart-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 sm:py-4 rounded-lg text-lg sm:text-xl btn-3d">
                        トップへ戻る
                    </button>
                </div>
            </div>
        </div>
    </div>

    <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
    <audio id="incorrect-sound" src="incorrect.mp3" preload="auto"></audio>

    <script>
        // DOM要素の取得
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startButton = document.getElementById('start-button');
        const quitButton = document.getElementById('quit-button');
        const stageDisplay = document.getElementById('stage-display');
        const maxStageDisplay = document.getElementById('max-stage-display');
        const timerDisplay = document.getElementById('timer-display');
        const problemNumberDisplay = document.getElementById('problem-number-display');
        const cardGrid = document.getElementById('card-grid');
        const correctSound = document.getElementById('correct-sound');
        const incorrectSound = document.getElementById('incorrect-sound');
        const questionCountSelector = document.getElementById('question-count-selector');

        // 結果画面の要素
        const restartButton = document.getElementById('restart-button');
        const retryButton = document.getElementById('retry-button');
        const resultTimeEl = document.getElementById('result-time');
        const resultPenaltyEl = document.getElementById('result-penalty');
        const resultScoreEl = document.getElementById('result-score');
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');

        // ゲームの状態を管理する変数
        let currentStage = 0;
        let problemNumber = 0;
        let divisors = [];
        let remainingDivisors = [];
        let penaltySeconds = 0;
        let timerInterval;
        let startTime;
        let incorrectCards = new Set();
        let confettiParticles = [];
        let animationFrameId;
        let maxStage = 3; // デフォルトの問題数
        const PENALTY_PER_MISTAKE = 3;
        let problemSet = []; // 問題のセットを保存する配列

        // イベントリスナーの設定
        startButton.addEventListener('click', () => startGame(false));
        restartButton.addEventListener('click', () => {
            stopConfetti();
            showScreen(startScreen);
        });
        retryButton.addEventListener('click', () => {
            stopConfetti();
            startGame(true); // 同じ問題で再挑戦
        });
        quitButton.addEventListener('click', () => {
            clearInterval(timerInterval);
            showScreen(startScreen);
        });
        questionCountSelector.addEventListener('click', (e) => {
            const button = e.target.closest('.question-count-btn');
            if (button) {
                document.querySelectorAll('.question-count-btn').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                maxStage = parseInt(button.dataset.count, 10);
            }
        });

        /**
         * 約数の配列を取得する関数
         * @param {number} num - 約数を探す対象の数
         * @returns {number[]} 約数の配列
         */
        function getDivisors(num) {
            const result = [];
            for (let i = 1; i <= num; i++) {
                if (num % i === 0) {
                    result.push(i);
                }
            }
            return result;
        }

        /**
         * 配列をシャッフルする関数（Fisher-Yatesアルゴリズム）
         * @param {Array} array - シャッフル対象の配列
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /**
         * ゲームを開始する関数
         * @param {boolean} isRetry - 同じ問題で再挑戦するかどうか
         */
        function startGame(isRetry = false) {
            currentStage = 0;
            penaltySeconds = 0;
            incorrectCards.clear();

            // リトライでない場合のみ新しい問題セットを生成
            if (!isRetry) {
                problemSet = [];
                for (let i = 0; i < maxStage; i++) {
                    problemSet.push(Math.floor(Math.random() * 50) + 1);
                }
            }

            maxStageDisplay.textContent = maxStage;
            showScreen(gameScreen);

            nextStage();
            startTimer();
        }

        /**
         * タイマーを開始する関数
         */
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 10);
        }

        /**
         * タイマー表示を更新する関数
         */
        function updateTimer() {
            const elapsedTime = (Date.now() - startTime) / 1000;
            const totalTime = elapsedTime + penaltySeconds;
            timerDisplay.textContent = totalTime.toFixed(2);
        }

        // --- Sound Effects ---
        function playSound(type) {
            const sound = new Audio(type === 'correct' ? '../sounds/correct.mp3' : '../sounds/incorrect.mp3');
            sound.play().catch(e => console.error(`Error playing ${type} sound:`, e));
        }

        /**
         * 次のステージに進む関数
         */
        function nextStage() {
            currentStage++;
            if (currentStage > maxStage) {
                endGame();
                return;
            }

            stageDisplay.textContent = currentStage;
            incorrectCards.clear();

            // 保存された問題セットからお題を取得
            problemNumber = problemSet[currentStage - 1];
            problemNumberDisplay.textContent = problemNumber;

            divisors = getDivisors(problemNumber);
            remainingDivisors = [...divisors];

            // カード用の数字を生成
            const cardNumbers = [...divisors];
            while (cardNumbers.length < 12) {
                const randomNumber = Math.floor(Math.random() * 50) + 1;
                // 重複せず、かつ約数でない数を追加
                if (!cardNumbers.includes(randomNumber)) {
                    cardNumbers.push(randomNumber);
                }
            }

            shuffleArray(cardNumbers);
            renderCards(cardNumbers);
        }

        /**
         * カードを画面に描画する関数
         * @param {number[]} numbers - カードに表示する数字の配列
         */
        function renderCards(numbers) {
            cardGrid.innerHTML = '';
            numbers.forEach(num => {
                const card = document.createElement('button');
                card.className = 'card bg-white hover:bg-indigo-100 border-2 border-slate-200 text-2xl font-bold p-4 rounded-lg aspect-square flex items-center justify-center transition focus:outline-none focus:ring-2 focus:ring-indigo-400';
                card.textContent = num;
                card.dataset.number = num;
                card.addEventListener('click', handleCardClick);
                cardGrid.appendChild(card);
            });
        }

        /**
         * カードクリック時の処理
         * @param {Event} event - クリックイベント
         */
        function handleCardClick(event) {
            const card = event.currentTarget;
            const number = parseInt(card.dataset.number, 10);

            // すでに正解したカードは無視
            if (card.classList.contains('is-correct')) {
                return;
            }

            const isCorrect = remainingDivisors.includes(number);

            if (isCorrect) {
                // 正解の処理
                card.classList.add('is-correct', 'border-indigo-500', 'bg-indigo-100');
                card.disabled = true;

                // remainingDivisorsから正解した数を削除
                const index = remainingDivisors.indexOf(number);
                if (index > -1) {
                    remainingDivisors.splice(index, 1);
                }

                // 全て正解したら次のステージへ
                if (remainingDivisors.length === 0) {
                    playSound('correct');
                    setTimeout(nextStage, 100);
                }
            } else {
                // 不正解の処理
                playSound('incorrect');
                if (!incorrectCards.has(number)) {
                    penaltySeconds += PENALTY_PER_MISTAKE;
                    incorrectCards.add(number);
                }
                card.classList.add('is-incorrect');
                card.addEventListener('animationend', () => {
                    card.classList.remove('is-incorrect');
                }, { once: true });
            }
        }

        /**
         * ゲームを終了する関数
         */
        function endGame() {
            clearInterval(timerInterval);

            const elapsedTime = (Date.now() - startTime) / 1000;
            const finalScore = elapsedTime + penaltySeconds;

            resultTimeEl.textContent = `${elapsedTime.toFixed(2)} 秒`;
            resultPenaltyEl.textContent = `+ ${penaltySeconds.toFixed(2)} 秒`;
            resultScoreEl.textContent = `${finalScore.toFixed(2)} 秒`;

            startConfetti();
            showScreen(endScreen);
        }

        /**
         * 指定された画面を表示し、他の画面を非表示にする関数
         * @param {HTMLElement} screenToShow - 表示する画面の要素
         */
        function showScreen(screenToShow) {
            // すべての画面を一旦非表示に
            startScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            endScreen.classList.add('hidden');

            // 対象の画面を表示
            screenToShow.classList.remove('hidden');

            // ゲーム画面の時だけスクロールを無効化
            if (screenToShow === gameScreen) {
                document.body.classList.add('no-scroll');
            } else {
                document.body.classList.remove('no-scroll');
            }
        }

        // --- Confetti Functions ---
        function startConfetti(){if(!confettiCanvas)return;confettiCanvas.width=window.innerWidth;confettiCanvas.height=window.innerHeight;confettiParticles=[];for(let i=0;i<100;i++){confettiParticles.push(createParticle())}renderConfetti()}
        function stopConfetti(){if(animationFrameId)cancelAnimationFrame(animationFrameId)}
        function createParticle(){const colors=['#f9a8d4','#f472b6','#86efac','#34d399','#67e8f9','#22d3ee','#fcd34d','#fbbf24'];return{x:Math.random()*confettiCanvas.width,y:Math.random()*confettiCanvas.height-confettiCanvas.height,size:Math.random()*8+5,color:colors[Math.floor(Math.random()*colors.length)],speed:Math.random()*3+2,angle:Math.random()*360,spin:Math.random()<.5?-1:1}}
        function renderConfetti(){if(!confettiCanvas)return;confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);confettiParticles.forEach((p,i)=>{p.y+=p.speed;p.angle+=p.spin*5;confettiCtx.save();confettiCtx.fillStyle=p.color;confettiCtx.translate(p.x+p.size/2,p.y+p.size/2);confettiCtx.rotate(p.angle*Math.PI/180);confettiCtx.fillRect(-p.size/2,-p.size/2,p.size,p.size);confettiCtx.restore();if(p.y>confettiCanvas.height){confettiParticles[i]=createParticle();confettiParticles[i].y=-10}});animationFrameId=requestAnimationFrame(renderConfetti)}

        // ページ読み込み時にレイアウトを調整
        window.addEventListener('load', () => {
            showScreen(startScreen);
        });

    </script>
</body>
</html>

