<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç´„æ•°ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    <style>
        html, body {
            width: 100%;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        /* M PLUS Rounded 1c ãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        body {
            font-family: 'Inter', 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’ç„¡åŠ¹åŒ– */
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢è¡¨ç¤ºä¸­ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ– */
        body.no-scroll {
            overflow: hidden;
            height: 100vh;
        }

        .btn-3d {
            transition: all 0.1s ease-out;
            box-shadow: 0 6px 0 #6b7280;
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #6b7280;
        }
        .question-count-btn {
            transition: all 0.2s ease;
        }
        .question-count-btn.selected {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 0 #3730a3; /* indigo-800 */
        }

        /* ã‚«ãƒ¼ãƒ‰ã®ãƒ•ãƒªãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .card {
            transform-style: preserve-3d;
            transition: transform 0.5s, opacity 0.5s;
        }
        .card.is-correct {
            transform: rotateY(180deg) scale(0.8);
            opacity: 0;
        }
        .card.is-incorrect {
            animation: shake 0.5s;
        }

        /* ã‚«ãƒ¼ãƒ‰ãŒæºã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); }
        }

        /* ç”»é¢ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆ */
        .screen {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* çµæœç”»é¢ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes celebrate-text {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .animate-celebrate { animation: celebrate-text 1s ease-in-out infinite; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen">

    <div id="game-container" class="w-full max-w-md mx-auto p-4 sm:p-6 text-center">

        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="start-screen" class="screen space-y-4 sm:space-y-6">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-600">ç´„æ•°ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯</h1>
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="text-left max-w-md mx-auto space-y-2 text-gray-600 mb-6 text-sm sm:text-base">
                    <p>ğŸš€ ãŠé¡Œã®æ•°ã®ç´„æ•°ã‚’ã™ã¹ã¦è¦‹ã¤ã‘ã‚‹ã‚²ãƒ¼ãƒ ã ã‚ˆã€‚</p>
                    <p>â±ï¸ å…¨å•æ­£è§£ã™ã‚‹ã¾ã§ã®ã‚¿ã‚¤ãƒ ã‚’ç«¶ãŠã†ï¼</p>
                    <p>âš ï¸ ã¾ã¡ãŒã£ãŸæ•°å­—ã‚’é¸ã¶ã¨ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚¿ã‚¤ãƒ ãŒ3ç§’ã¤ã„ã‹ã•ã‚Œã‚‹ã‚ˆã€‚</p>
                </div>

                <div class="mt-6">
                    <p class="text-lg sm:text-xl font-bold mb-4">ãªã‚“å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹ï¼Ÿ</p>
                    <div id="question-count-selector" class="flex justify-center gap-2 sm:gap-4">
                        <button class="question-count-btn btn-3d bg-gray-200 text-xl sm:text-2xl font-bold py-3 px-4 sm:px-6 rounded-lg selected" data-count="3">3å•</button>
                        <button class="question-count-btn btn-3d bg-gray-200 text-xl sm:text-2xl font-bold py-3 px-4 sm:px-6 rounded-lg" data-count="5">5å•</button>
                        <button class="question-count-btn btn-3d bg-gray-200 text-xl sm:text-2xl font-bold py-3 px-4 sm:px-6 rounded-lg" data-count="10">10å•</button>
                    </div>
                </div>

                <button id="start-button" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 sm:py-4 rounded-lg text-2xl sm:text-3xl btn-3d">
                    ã‚¹ã‚¿ãƒ¼ãƒˆï¼
                </button>
                <p class="text-xs sm:text-sm text-gray-500 mt-4 sm:mt-6">åŠ¹æœéŸ³ï¼šOtoLogic</p>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen" class="screen hidden">
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-4">
                <div class="flex justify-between items-center text-lg">
                    <div class="text-left">
                        <span class="text-slate-500">ã‚¹ãƒ†ãƒ¼ã‚¸</span>
                        <p class="font-bold text-2xl"><span id="stage-display">1</span> / <span id="max-stage-display">3</span></p>
                    </div>
                    <div class="text-right">
                         <span class="text-slate-500">ã‚¿ã‚¤ãƒ </span>
                        <p class="font-bold text-2xl"><span id="timer-display">0.00</span></p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl text-slate-600 mb-1">ãŠé¡Œ</h2>
                <p id="problem-number-display" class="text-5xl sm:text-6xl font-bold text-indigo-600 mb-6"></p>
                <!-- æ•°å­—ã‚«ãƒ¼ãƒ‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                <div id="card-grid" class="grid grid-cols-4 gap-3">
                    <!-- JavaScriptã§ã‚«ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
            </div>

            <div class="mt-6">
                 <button id="quit-button" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg text-lg btn-3d" style="box-shadow: 0 6px 0 #4b5563;">
                    ã‚²ãƒ¼ãƒ ã‚’ã‚„ã‚ã‚‹
                </button>
            </div>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="end-screen" class="screen hidden">
            <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none"></canvas>
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl space-y-4 sm:space-y-6">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 animate-celebrate">ã‚¯ãƒªã‚¢ï¼</h1>

                <div class="grid grid-cols-1 gap-2 sm:gap-4 text-center text-lg sm:text-xl">
                    <div class="bg-gray-100 p-3 sm:p-4 rounded-lg">
                        <p class="text-base sm:text-lg text-gray-500">ã‹ã‹ã£ãŸæ™‚é–“</p>
                        <p id="result-time" class="font-bold"></p>
                    </div>
                    <div class="bg-gray-100 p-3 sm:p-4 rounded-lg">
                        <p class="text-base sm:text-lg text-gray-500">ãƒšãƒŠãƒ«ãƒ†ã‚£</p>
                        <p id="result-penalty" class="font-bold text-red-500"></p>
                    </div>
                    <div class="bg-gray-100 p-3 sm:p-4 rounded-lg">
                        <p class="text-base sm:text-lg text-gray-500">æœ€çµ‚ã‚¹ã‚³ã‚¢</p>
                        <p id="result-score" class="font-bold text-indigo-500"></p>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 mt-6">
                    <button id="retry-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 sm:py-4 rounded-lg text-lg sm:text-xl btn-3d" style="box-shadow: 0 6px 0 #166534;">
                        å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸
                    </button>
                    <button id="restart-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 sm:py-4 rounded-lg text-lg sm:text-xl btn-3d">
                        ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
    <audio id="incorrect-sound" src="incorrect.mp3" preload="auto"></audio>

    <script>
        // DOMè¦ç´ ã®å–å¾—
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startButton = document.getElementById('start-button');
        const quitButton = document.getElementById('quit-button');
        const stageDisplay = document.getElementById('stage-display');
        const maxStageDisplay = document.getElementById('max-stage-display');
        const timerDisplay = document.getElementById('timer-display');
        const problemNumberDisplay = document.getElementById('problem-number-display');
        const cardGrid = document.getElementById('card-grid');
        const correctSound = document.getElementById('correct-sound');
        const incorrectSound = document.getElementById('incorrect-sound');
        const questionCountSelector = document.getElementById('question-count-selector');

        // çµæœç”»é¢ã®è¦ç´ 
        const restartButton = document.getElementById('restart-button');
        const retryButton = document.getElementById('retry-button');
        const resultTimeEl = document.getElementById('result-time');
        const resultPenaltyEl = document.getElementById('result-penalty');
        const resultScoreEl = document.getElementById('result-score');
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');

        // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹å¤‰æ•°
        let currentStage = 0;
        let problemNumber = 0;
        let divisors = [];
        let remainingDivisors = [];
        let penaltySeconds = 0;
        let timerInterval;
        let startTime;
        let incorrectCards = new Set();
        let confettiParticles = [];
        let animationFrameId;
        let maxStage = 3; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å•é¡Œæ•°
        const PENALTY_PER_MISTAKE = 3;
        let problemSet = []; // å•é¡Œã®ã‚»ãƒƒãƒˆã‚’ä¿å­˜ã™ã‚‹é…åˆ—

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        startButton.addEventListener('click', () => startGame(false));
        restartButton.addEventListener('click', () => {
            stopConfetti();
            showScreen(startScreen);
        });
        retryButton.addEventListener('click', () => {
            stopConfetti();
            startGame(true); // åŒã˜å•é¡Œã§å†æŒ‘æˆ¦
        });
        quitButton.addEventListener('click', () => {
            clearInterval(timerInterval);
            showScreen(startScreen);
        });
        questionCountSelector.addEventListener('click', (e) => {
            const button = e.target.closest('.question-count-btn');
            if (button) {
                document.querySelectorAll('.question-count-btn').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                maxStage = parseInt(button.dataset.count, 10);
            }
        });

        /**
         * ç´„æ•°ã®é…åˆ—ã‚’å–å¾—ã™ã‚‹é–¢æ•°
         * @param {number} num - ç´„æ•°ã‚’æ¢ã™å¯¾è±¡ã®æ•°
         * @returns {number[]} ç´„æ•°ã®é…åˆ—
         */
        function getDivisors(num) {
            const result = [];
            for (let i = 1; i <= num; i++) {
                if (num % i === 0) {
                    result.push(i);
                }
            }
            return result;
        }

        /**
         * é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é–¢æ•°ï¼ˆFisher-Yatesã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
         * @param {Array} array - ã‚·ãƒ£ãƒƒãƒ•ãƒ«å¯¾è±¡ã®é…åˆ—
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
         * @param {boolean} isRetry - åŒã˜å•é¡Œã§å†æŒ‘æˆ¦ã™ã‚‹ã‹ã©ã†ã‹
         */
        function startGame(isRetry = false) {
            currentStage = 0;
            penaltySeconds = 0;
            incorrectCards.clear();

            // ãƒªãƒˆãƒ©ã‚¤ã§ãªã„å ´åˆã®ã¿æ–°ã—ã„å•é¡Œã‚»ãƒƒãƒˆã‚’ç”Ÿæˆ
            if (!isRetry) {
                problemSet = [];
                for (let i = 0; i < maxStage; i++) {
                    problemSet.push(Math.floor(Math.random() * 50) + 1);
                }
            }

            maxStageDisplay.textContent = maxStage;
            showScreen(gameScreen);

            nextStage();
            startTimer();
        }

        /**
         * ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
         */
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 10);
        }

        /**
         * ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        function updateTimer() {
            const elapsedTime = (Date.now() - startTime) / 1000;
            const totalTime = elapsedTime + penaltySeconds;
            timerDisplay.textContent = totalTime.toFixed(2);
        }

        // --- Sound Effects ---
        function playSound(type) {
            const sound = new Audio(type === 'correct' ? '../sounds/correct.mp3' : '../sounds/incorrect.mp3');
            sound.play().catch(e => console.error(`Error playing ${type} sound:`, e));
        }

        /**
         * æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«é€²ã‚€é–¢æ•°
         */
        function nextStage() {
            currentStage++;
            if (currentStage > maxStage) {
                endGame();
                return;
            }

            stageDisplay.textContent = currentStage;
            incorrectCards.clear();

            // ä¿å­˜ã•ã‚ŒãŸå•é¡Œã‚»ãƒƒãƒˆã‹ã‚‰ãŠé¡Œã‚’å–å¾—
            problemNumber = problemSet[currentStage - 1];
            problemNumberDisplay.textContent = problemNumber;

            divisors = getDivisors(problemNumber);
            remainingDivisors = [...divisors];

            // ã‚«ãƒ¼ãƒ‰ç”¨ã®æ•°å­—ã‚’ç”Ÿæˆ
            const cardNumbers = [...divisors];
            while (cardNumbers.length < 12) {
                const randomNumber = Math.floor(Math.random() * 50) + 1;
                // é‡è¤‡ã›ãšã€ã‹ã¤ç´„æ•°ã§ãªã„æ•°ã‚’è¿½åŠ 
                if (!cardNumbers.includes(randomNumber)) {
                    cardNumbers.push(randomNumber);
                }
            }

            shuffleArray(cardNumbers);
            renderCards(cardNumbers);
        }

        /**
         * ã‚«ãƒ¼ãƒ‰ã‚’ç”»é¢ã«æç”»ã™ã‚‹é–¢æ•°
         * @param {number[]} numbers - ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºã™ã‚‹æ•°å­—ã®é…åˆ—
         */
        function renderCards(numbers) {
            cardGrid.innerHTML = '';
            numbers.forEach(num => {
                const card = document.createElement('button');
                card.className = 'card bg-white hover:bg-indigo-100 border-2 border-slate-200 text-2xl font-bold p-4 rounded-lg aspect-square flex items-center justify-center transition focus:outline-none focus:ring-2 focus:ring-indigo-400';
                card.textContent = num;
                card.dataset.number = num;
                card.addEventListener('click', handleCardClick);
                cardGrid.appendChild(card);
            });
        }

        /**
         * ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
         * @param {Event} event - ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
         */
        function handleCardClick(event) {
            const card = event.currentTarget;
            const number = parseInt(card.dataset.number, 10);

            // ã™ã§ã«æ­£è§£ã—ãŸã‚«ãƒ¼ãƒ‰ã¯ç„¡è¦–
            if (card.classList.contains('is-correct')) {
                return;
            }

            const isCorrect = remainingDivisors.includes(number);

            if (isCorrect) {
                // æ­£è§£ã®å‡¦ç†
                card.classList.add('is-correct', 'border-indigo-500', 'bg-indigo-100');
                card.disabled = true;

                // remainingDivisorsã‹ã‚‰æ­£è§£ã—ãŸæ•°ã‚’å‰Šé™¤
                const index = remainingDivisors.indexOf(number);
                if (index > -1) {
                    remainingDivisors.splice(index, 1);
                }

                // å…¨ã¦æ­£è§£ã—ãŸã‚‰æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸
                if (remainingDivisors.length === 0) {
                    playSound('correct');
                    setTimeout(nextStage, 100);
                }
            } else {
                // ä¸æ­£è§£ã®å‡¦ç†
                playSound('incorrect');
                if (!incorrectCards.has(number)) {
                    penaltySeconds += PENALTY_PER_MISTAKE;
                    incorrectCards.add(number);
                }
                card.classList.add('is-incorrect');
                card.addEventListener('animationend', () => {
                    card.classList.remove('is-incorrect');
                }, { once: true });
            }
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹é–¢æ•°
         */
        function endGame() {
            clearInterval(timerInterval);

            const elapsedTime = (Date.now() - startTime) / 1000;
            const finalScore = elapsedTime + penaltySeconds;

            resultTimeEl.textContent = `${elapsedTime.toFixed(2)} ç§’`;
            resultPenaltyEl.textContent = `+ ${penaltySeconds.toFixed(2)} ç§’`;
            resultScoreEl.textContent = `${finalScore.toFixed(2)} ç§’`;

            startConfetti();
            showScreen(endScreen);
        }

        /**
         * æŒ‡å®šã•ã‚ŒãŸç”»é¢ã‚’è¡¨ç¤ºã—ã€ä»–ã®ç”»é¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°
         * @param {HTMLElement} screenToShow - è¡¨ç¤ºã™ã‚‹ç”»é¢ã®è¦ç´ 
         */
        function showScreen(screenToShow) {
            // ã™ã¹ã¦ã®ç”»é¢ã‚’ä¸€æ—¦éè¡¨ç¤ºã«
            startScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            endScreen.classList.add('hidden');

            // å¯¾è±¡ã®ç”»é¢ã‚’è¡¨ç¤º
            screenToShow.classList.remove('hidden');

            // ã‚²ãƒ¼ãƒ ç”»é¢ã®æ™‚ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
            if (screenToShow === gameScreen) {
                document.body.classList.add('no-scroll');
            } else {
                document.body.classList.remove('no-scroll');
            }
        }

        // --- Confetti Functions ---
        function startConfetti(){if(!confettiCanvas)return;confettiCanvas.width=window.innerWidth;confettiCanvas.height=window.innerHeight;confettiParticles=[];for(let i=0;i<100;i++){confettiParticles.push(createParticle())}renderConfetti()}
        function stopConfetti(){if(animationFrameId)cancelAnimationFrame(animationFrameId)}
        function createParticle(){const colors=['#f9a8d4','#f472b6','#86efac','#34d399','#67e8f9','#22d3ee','#fcd34d','#fbbf24'];return{x:Math.random()*confettiCanvas.width,y:Math.random()*confettiCanvas.height-confettiCanvas.height,size:Math.random()*8+5,color:colors[Math.floor(Math.random()*colors.length)],speed:Math.random()*3+2,angle:Math.random()*360,spin:Math.random()<.5?-1:1}}
        function renderConfetti(){if(!confettiCanvas)return;confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);confettiParticles.forEach((p,i)=>{p.y+=p.speed;p.angle+=p.spin*5;confettiCtx.save();confettiCtx.fillStyle=p.color;confettiCtx.translate(p.x+p.size/2,p.y+p.size/2);confettiCtx.rotate(p.angle*Math.PI/180);confettiCtx.fillRect(-p.size/2,-p.size/2,p.size,p.size);confettiCtx.restore();if(p.y>confettiCanvas.height){confettiParticles[i]=createParticle();confettiParticles[i].y=-10}});animationFrameId=requestAnimationFrame(renderConfetti)}

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’èª¿æ•´
        window.addEventListener('load', () => {
            showScreen(startScreen);
        });

    </script>
</body>
</html>

