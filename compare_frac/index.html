<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分数大小比較チャレンジ</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    <style>
        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation;
        }
        .btn-3d {
            transition: all 0.1s ease-out;
            box-shadow: 0 6px 0 #a3a3a3;
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #a3a3a3;
        }
        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 0.5rem; /* Reduced margin for smaller screens */
            font-size: 2.5rem; /* Base font size for mobile */
            line-height: 1.1;
        }
        .numerator {
            padding-bottom: 0.25rem;
        }
        .denominator {
            border-top: 3px solid currentColor;
            padding-top: 0.25rem;
        }
        .hidden {
            display: none;
        }
        #scratchpad {
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: crosshair;
            background-color: #f9fafb;
        }
        .answer-btn {
            font-size: 2rem; /* Base font size for mobile */
            width: 70px; /* Base size for mobile */
            height: 70px;
        }
        .question-count-btn {
            transition: all 0.2s ease;
        }
        .question-count-btn.selected {
            background-color: #06b6d4; /* cyan-500 */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 0 #0891b2;
        }
         @keyframes celebrate-text {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .animate-celebrate { animation: celebrate-text 1s ease-in-out infinite; }

        /* ポップアップ用のスタイル */
        .modal-enter { opacity: 0; }
        .modal-enter-active { opacity: 1; transition: opacity 200ms ease-out; }
        .modal-leave { opacity: 1; }
        .modal-leave-active { opacity: 0; transition: opacity 200ms ease-in; }
        .modal-content-enter { transform: scale(0.95); }
        .modal-content-enter-active { transform: scale(1); transition: transform 200ms ease-out; }
        .modal-content-leave { transform: scale(1); }
        .modal-content-leave-active { transform: scale(0.95); transition: transform 200ms ease-in; }

        /* Responsive adjustments */
        @media (min-width: 640px) { /* sm breakpoint */
            .fraction {
                font-size: 3.5rem;
                margin: 0 1rem;
            }
            .answer-btn {
                font-size: 3rem;
                width: 90px;
                height: 90px;
            }
        }
    </style>
</head>
<body class="bg-yellow-50 text-gray-800 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div id="main-container" class="w-full max-w-2xl mx-auto text-center">

        <!-- サウンドオン/オフボタン -->
        <button id="mute-button" class="absolute top-4 right-4 sm:top-6 sm:right-6 text-slate-400 hover:text-slate-600 z-10 p-2 rounded-full hover:bg-slate-200 transition">
            <svg id="sound-on-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
            <svg id="sound-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
        </button>

        <!-- Start Screen -->
        <div id="start-screen" class="space-y-4 sm:space-y-6">
            <a href="https://manameba.com/" class="absolute top-4 left-4 sm:top-6 sm:left-6 text-slate-400 hover:text-slate-600 transition-colors z-10 text-sm flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="m15 18-6-6 6-6"/></svg>
                <span>ホームにもどる</span>
            </a>
            <h1 class="text-4xl sm:text-5xl font-extrabold text-amber-600">分数大小比較<br>チャレンジ</h1>
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="text-left max-w-md mx-auto space-y-2 text-gray-600 mb-6 text-sm sm:text-base">
                    <p>🚀 2つの分数の大きさを比べるゲームだよ。</p>
                    <p>⏱️ 正解するまでのタイムを競おう！</p>
                    <p>⚠️ まちがえるとペナルティタイムが3秒ついかされるよ。</p>
                    <p>✍️ 計算メモを自由に使って考えよう。</p>
                </div>

                <div class="mt-6">
                    <p class="text-lg sm:text-xl font-bold mb-4">なん問チャレンジする？</p>
                    <div id="question-count-selector" class="flex justify-center gap-2 sm:gap-4">
                        <button class="question-count-btn btn-3d bg-gray-200 text-xl sm:text-2xl font-bold py-3 px-4 sm:px-6 rounded-lg selected" data-count="3">3問</button>
                        <button class="question-count-btn btn-3d bg-gray-200 text-xl sm:text-2xl font-bold py-3 px-4 sm:px-6 rounded-lg" data-count="5">5問</button>
                        <button class="question-count-btn btn-3d bg-gray-200 text-xl sm:text-2xl font-bold py-3 px-4 sm:px-6 rounded-lg" data-count="10">10問</button>
                    </div>
                </div>

                <button id="start-button" class="mt-8 w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 sm:py-4 rounded-lg text-2xl sm:text-3xl btn-3d" style="box-shadow: 0 6px 0 #0891b2;">
                    スタート！
                </button>
                 <button id="how-to-play-button" class="mt-4 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg text-lg btn-3d" style="box-shadow: 0 6px 0 #4b5563;">
                    あそびかた
                </button>
                <p class="text-xs sm:text-sm text-gray-500 mt-4 sm:mt-6">効果音：OtoLogic</p>
            </div>
        </div>


        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
             <div class="bg-white p-4 sm:p-6 md:p-8 rounded-2xl shadow-lg">
                <!-- Header Info -->
                <div class="flex flex-wrap justify-between items-center mb-4 sm:mb-6 text-base sm:text-xl gap-2">
                    <div class="bg-gray-200 px-4 py-2 rounded-full">
                        正解: <span id="correct-count" class="font-bold text-xl sm:text-2xl text-green-500">0</span> / <span id="target-count">3</span>
                    </div>
                    <div class="bg-gray-200 px-4 py-2 rounded-full">
                        タイム: <span id="timer" class="font-bold text-xl sm:text-2xl text-yellow-500">0.00</span>
                    </div>
                </div>

                <!-- Question Display -->
                <div id="question-area" class="flex items-center justify-center my-6 sm:my-8 md:my-10 bg-gray-100 p-4 sm:p-6 rounded-lg min-h-[120px] sm:min-h-[150px]">
                    <div id="frac1" class="fraction">
                        <span class="numerator">1</span>
                        <span class="denominator">2</span>
                    </div>
                    <div id="placeholder" class="text-4xl sm:text-6xl font-bold text-amber-500 mx-2 sm:mx-4">?</div>
                    <div id="frac2" class="fraction">
                        <span class="numerator">2</span>
                        <span class="denominator">3</span>
                    </div>
                </div>

                <!-- Answer Buttons -->
                <div id="answer-buttons" class="flex justify-center space-x-2 sm:space-x-4 md:space-x-8 my-6 sm:my-8">
                    <button class="answer-btn btn-3d bg-blue-400 hover:bg-blue-500 text-white rounded-full flex items-center justify-center" data-answer="<">&lt;</button>
                    <button class="answer-btn btn-3d bg-blue-400 hover:bg-blue-500 text-white rounded-full flex items-center justify-center" data-answer="=">=</button>
                    <button class="answer-btn btn-3d bg-blue-400 hover:bg-blue-500 text-white rounded-full flex items-center justify-center" data-answer=">">&gt;</button>
                </div>

                <!-- Calculation Area -->
                <div class="mt-6 sm:mt-8 text-center">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg sm:text-xl font-bold text-gray-600">計算メモ</h3>
                        <button id="clear-canvas-btn" class="bg-red-500 hover:bg-red-600 text-white text-sm sm:text-md font-bold py-2 px-4 sm:px-5 rounded-lg btn-3d" style="box-shadow: 0 6px 0 #b91c1c;">
                            けす
                        </button>
                    </div>
                    <canvas id="scratchpad"></canvas>
                </div>
            </div>
            <div class="mt-6">
                <button id="quit-button" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg text-lg btn-3d" style="box-shadow: 0 6px 0 #4b5563;">
                    ゲームをやめる
                </button>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden">
            <canvas id="confetti-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
            <div class="bg-white p-6 sm:p-12 rounded-2xl shadow-2xl space-y-4 sm:space-y-6">
                <h1 class="text-4xl sm:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 animate-celebrate">クリア！<br>おめでとう！</h1>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 sm:gap-4 text-center text-xl sm:text-2xl">
                    <div class="bg-gray-100 p-3 sm:p-4 rounded-lg">
                        <p class="text-base sm:text-lg text-gray-500">かかった時間</p>
                        <p id="result-time" class="font-bold"></p>
                    </div>
                    <div class="bg-gray-100 p-3 sm:p-4 rounded-lg">
                        <p class="text-base sm:text-lg text-gray-500">ペナルティ</p>
                        <p id="result-penalty" class="font-bold text-red-500"></p>
                    </div>
                    <div class="bg-gray-100 p-3 sm:p-4 rounded-lg">
                        <p class="text-base sm:text-lg text-gray-500">最終スコア</p>
                        <p id="result-score" class="font-bold text-amber-500"></p>
                    </div>
                </div>

                <div id="history-area" class="text-left max-h-40 sm:max-h-48 overflow-y-auto bg-gray-50 p-4 rounded-lg border">
                     <h3 class="text-lg sm:text-xl font-bold text-center mb-4">もんだいのふりかえり</h3>
                     <div id="history-table-body" class="text-sm sm:text-base"></div>
                </div>

                <button id="restart-button" class="w-full bg-cyan-400 hover:bg-cyan-500 text-white font-bold py-4 sm:py-5 px-10 rounded-lg text-2xl sm:text-3xl btn-3d" style="box-shadow: 0 6px 0 #0e7490;">
                    トップへ戻る
                </button>
            </div>
        </div>
    </div>

    <!-- あそびかたモーダル -->
    <div id="how-to-play-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 modal-enter">
        <div id="modal-content" class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-lg text-left relative modal-content-enter">
            <h2 class="text-2xl sm:text-3xl font-bold text-amber-600 mb-6 text-center">あそびかた</h2>
            <div class="space-y-4 text-gray-700 text-base sm:text-lg">
                <p><span class="font-bold text-cyan-500">① 問題数をえらぶ</span><br>挑戦する問題数をえらんで「スタート！」を押してね。</p>
                <p><span class="font-bold text-cyan-500">② 大きさをくらべる</span><br>左右の分数の大きさを比べて、右の分数が大きいと思ったら「<span class="font-bold text-xl">&lt;</span>」、同じ大きさだと思ったら「<span class="font-bold text-xl">=</span>」、左の分数が大きいと思ったら「<span class="font-bold text-xl">&gt;</span>」 のボタンで答えよう。</p>
                <p><span class="font-bold text-green-500">💡 計算メモをつかおう</span><br>通分などのむずかしい計算は、下の「計算メモ」を使って考えられるよ。慣れてきたらメモを使わなくてもOK！</p>
                <p><span class="font-bold text-cyan-500">③ タイムをきそえ</span><br>最終タイムを競って遊んでね！</p>
                <p><span class="font-bold text-red-500">⚠️ ペナルティ</span><br>まちがった答えをえらぶと、<span class="font-bold">3秒のペナルティタイム</span>が追加されるよ。</p>
                <p><span class="font-bold text-cyan-500">④ 見直そう</span><br>間違えた問題はしっかり復習して、何度も挑戦しよう</p>
                <p><span class="font-bold text-black-500 text-center">さあ、楽しく分数をマスターだ！</span></p>
            </div>
            <button id="close-modal-button" class="mt-8 w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg text-lg btn-3d" style="box-shadow: 0 6px 0 #0891b2;">
                わかった！
            </button>
        </div>
    </div>


    <script>
        // DOM Elements
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const quitButton = document.getElementById('quit-button');
        const correctCountEl = document.getElementById('correct-count');
        const targetCountEl = document.getElementById('target-count');
        const timerEl = document.getElementById('timer');
        const frac1El = document.getElementById('frac1');
        const frac2El = document.getElementById('frac2');
        const answerButtons = document.querySelectorAll('.answer-btn');
        const canvas = document.getElementById('scratchpad');
        const clearCanvasBtn = document.getElementById('clear-canvas-btn');
        const resultTimeEl = document.getElementById('result-time');
        const resultPenaltyEl = document.getElementById('result-penalty');
        const resultScoreEl = document.getElementById('result-score');
        const historyTableBodyEl = document.getElementById('history-table-body');
        const placeholderEl = document.getElementById('placeholder');
        const questionCountSelector = document.getElementById('question-count-selector');
        const muteButton = document.getElementById('mute-button');
        const soundOnIcon = document.getElementById('sound-on-icon');
        const soundOffIcon = document.getElementById('sound-off-icon');

        // Modal elements
        const howToPlayButton = document.getElementById('how-to-play-button');
        const howToPlayModal = document.getElementById('how-to-play-modal');
        const closeModalButton = document.getElementById('close-modal-button');

        // Game State
        let correctCount = 0;
        let wrongCount = 0;
        let targetCorrectCount = 3;
        let timerInterval;
        let startTime;
        let history = [];
        let currentQuestion = {};
        let isMuted = false;

        // Canvas
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function resizeCanvas() {
            const containerWidth = canvas.parentElement.clientWidth;
            canvas.width = containerWidth;
            canvas.height = containerWidth / 2.5;
            if (canvas.height > 200) canvas.height = 200;
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        // --- Modal Functions ---
        function showModal() {
            howToPlayModal.classList.remove('hidden');
            setTimeout(() => {
                howToPlayModal.classList.remove('modal-enter', 'modal-content-enter');
                howToPlayModal.classList.add('modal-enter-active', 'modal-content-enter-active');
            }, 10);
        }

        function hideModal() {
            howToPlayModal.classList.remove('modal-enter-active', 'modal-content-enter-active');
            howToPlayModal.classList.add('modal-leave', 'modal-content-leave');
            setTimeout(() => {
                howToPlayModal.classList.add('hidden');
                howToPlayModal.classList.remove('modal-leave', 'modal-content-leave');
            }, 200);
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', () => {
            stopConfetti();
            resultScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
        quitButton.addEventListener('click', () => {
            clearInterval(timerInterval);
            gameScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
        answerButtons.forEach(button => {
            button.addEventListener('click', () => checkAnswer(button.dataset.answer));
        });
        clearCanvasBtn.addEventListener('click', () => {
             ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        questionCountSelector.addEventListener('click', (e) => {
            const button = e.target.closest('.question-count-btn');
            if (button) {
                document.querySelectorAll('.question-count-btn').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                targetCorrectCount = parseInt(button.dataset.count, 10);
            }
        });
        muteButton.addEventListener('click', () => {
            isMuted = !isMuted;
            soundOnIcon.classList.toggle('hidden', isMuted);
            soundOffIcon.classList.toggle('hidden', !isMuted);
        });

        // Modal event listeners
        howToPlayButton.addEventListener('click', showModal);
        closeModalButton.addEventListener('click', hideModal);
        howToPlayModal.addEventListener('click', (e) => {
            if (e.target === howToPlayModal) {
                hideModal();
            }
        });


        // Canvas drawing events
        canvas.addEventListener('mousedown', (e) => startDrawing(e.offsetX, e.offsetY));
        canvas.addEventListener('mousemove', (e) => draw(e.offsetX, e.offsetY));
        canvas.addEventListener('mouseup', () => stopDrawing());
        canvas.addEventListener('mouseout', () => stopDrawing());
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = e.target.getBoundingClientRect();
            startDrawing(e.targetTouches[0].clientX - rect.left, e.targetTouches[0].clientY - rect.top);
        });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const rect = e.target.getBoundingClientRect();
            draw(e.targetTouches[0].clientX - rect.left, e.targetTouches[0].clientY - rect.top);
        });
        canvas.addEventListener('touchend', stopDrawing);
        window.addEventListener('resize', resizeCanvas);

        // --- Canvas Functions ---
        function startDrawing(x, y) { isDrawing = true; [lastX, lastY] = [x, y]; }
        function draw(x, y) {
            if (!isDrawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            [lastX, lastY] = [x, y];
        }
        function stopDrawing() { isDrawing = false; }

        // --- Sound Effects ---
        function playSound(type) {
            if (isMuted) return;
            const sound = new Audio(type === 'correct' ? '../sounds/correct.mp3' : '../sounds/incorrect.mp3');
            sound.play().catch(e => console.error(`Error playing ${type} sound:`, e));
        }

        // --- Game Logic ---
        function startGame() {
            correctCount = 0;
            wrongCount = 0;
            history = [];
            correctCountEl.textContent = '0';
            targetCountEl.textContent = targetCorrectCount;

            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            resizeCanvas();
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 100);
            updateTimer();
            nextQuestion();
        }

        function updateTimer() {
            const elapsedTime = (Date.now() - startTime) / 1000;
            timerEl.textContent = elapsedTime.toFixed(2);
        }

        function generateFractions() {
            let num1, den1, num2, den2;
            do {
                den1 = Math.floor(Math.random() * 9) + 2;
                den2 = Math.floor(Math.random() * 9) + 2;
            } while (den1 === den2);

            num1 = Math.floor(Math.random() * (den1 - 1)) + 1;
            num2 = Math.floor(Math.random() * (den2 - 1)) + 1;

            if (Math.random() < 0.05) {
                const multiplier = Math.floor(Math.random() * 3) + 2;
                num2 = num1 * multiplier;
                den2 = den1 * multiplier;
            }

            const val1 = num1 / den1;
            const val2 = num2 / den2;
            let answer = (Math.abs(val1 - val2) < 0.0001) ? '=' : (val1 < val2 ? '<' : '>');

            return { frac1: { num: num1, den: den1 }, frac2: { num: num2, den: den2 }, answer };
        }

        function nextQuestion() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // 計算メモをリセット
            currentQuestion = generateFractions();
            frac1El.innerHTML = `<span class="numerator">${currentQuestion.frac1.num}</span><span class="denominator">${currentQuestion.frac1.den}</span>`;
            frac2El.innerHTML = `<span class="numerator">${currentQuestion.frac2.num}</span><span class="denominator">${currentQuestion.frac2.den}</span>`;
            placeholderEl.textContent = '?';
            placeholderEl.classList.remove('text-green-500', 'text-red-500');
            placeholderEl.classList.add('text-amber-500');
            answerButtons.forEach(b => b.disabled = false);
        }

        function checkAnswer(userAnswer) {
            answerButtons.forEach(b => b.disabled = true);
            const isCorrect = userAnswer === currentQuestion.answer;

            // NOTE: 正解・不正解のサウンドを再生
            playSound(isCorrect ? 'correct' : 'incorrect');

            history.push({ question: currentQuestion, userAnswer, isCorrect });

            placeholderEl.textContent = isCorrect ? '◯' : '✕';
            placeholderEl.classList.remove('text-amber-500');
            placeholderEl.classList.add(isCorrect ? 'text-green-500' : 'text-red-500');

            if (isCorrect) correctCount++;
            else wrongCount++;

            correctCountEl.textContent = correctCount;

            if (correctCount >= targetCorrectCount) {
                setTimeout(endGame, 800);
            } else {
                setTimeout(nextQuestion, 800);
            }
        }

        function endGame() {
            clearInterval(timerInterval);
            const elapsedTime = (Date.now() - startTime) / 1000;
            const penalty = wrongCount * 3;
            const finalScore = elapsedTime + penalty;

            resultTimeEl.textContent = `${elapsedTime.toFixed(2)} 秒`;
            resultPenaltyEl.textContent = `+ ${penalty.toFixed(2)} 秒 (${wrongCount}回)`;
            resultScoreEl.textContent = `${finalScore.toFixed(2)} 秒`;

            displayHistory();
            startConfetti();

            gameScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
        }

        function displayHistory() {
            historyTableBodyEl.innerHTML = '';
            history.forEach((item, index) => {
                const q = item.question;
                const resultIcon = item.isCorrect ? '<span class="text-green-500 font-bold">正解</span>' : `<span class="text-red-500 font-bold">不正解 (正解: ${q.answer})</span>`;
                const row = `
                    <div class="border-b border-gray-200 py-2">
                        <span class="font-bold">${index + 1}.</span> ${q.frac1.num}/${q.frac1.den} <span class="font-bold text-amber-600">${item.userAnswer}</span> ${q.frac2.num}/${q.frac2.den} &nbsp; ${resultIcon}
                    </div>
                `;
                historyTableBodyEl.innerHTML += row;
            });
        }

        // --- Confetti ---
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');
        let confettiParticles = [];
        let animationFrameId;
        function startConfetti(){if(!confettiCanvas)return;confettiCanvas.width=window.innerWidth;confettiCanvas.height=window.innerHeight;confettiParticles=[];for(let i=0;i<100;i++){confettiParticles.push(createParticle())}renderConfetti()}
        function stopConfetti(){if(animationFrameId)cancelAnimationFrame(animationFrameId)}
        function createParticle(){const colors=['#f9a8d4','#f472b6','#86efac','#34d399','#67e8f9','#22d3ee','#fcd34d','#fbbf24'];return{x:Math.random()*confettiCanvas.width,y:Math.random()*confettiCanvas.height-confettiCanvas.height,size:Math.random()*8+5,color:colors[Math.floor(Math.random()*colors.length)],speed:Math.random()*3+2,angle:Math.random()*360,spin:Math.random()<.5?-1:1}}
        function renderConfetti(){if(!confettiCanvas)return;confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);confettiParticles.forEach((p,i)=>{p.y+=p.speed;p.angle+=p.spin*5;confettiCtx.save();confettiCtx.fillStyle=p.color;confettiCtx.translate(p.x+p.size/2,p.y+p.size/2);confettiCtx.rotate(p.angle*Math.PI/180);confettiCtx.fillRect(-p.size/2,-p.size/2,p.size,p.size);confettiCtx.restore();if(p.y>confettiCanvas.height){confettiParticles[i]=createParticle();confettiParticles[i].y=-10}});animationFrameId=requestAnimationFrame(renderConfetti)}

        // Initial setup
        resizeCanvas();
    </script>
</body>
</html>
